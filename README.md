# Fujitake App

このアプリケーションは、家族での利用を想定した多機能ファイラー＆ツールアプリです。Firebaseと連携し、家庭内のNAS（Network Attached Storage）にあるファイルへ簡単にアクセスできる機能を提供します。

## 主な機能

### 1. ユーザー認証
-   Firebase Authenticationを利用した、メールアドレスとパスワードによる安全なログイン・新規登録機能を提供します。

### 2. NASファイル管理
-   SMBプロトコルに対応したNASに接続し、ファイルやフォルダを直感的に操作できます。
-   **主な操作**:
    -   ファイル・フォルダの一覧表示
    -   ファイルのダウンロード＆アップロード
    -   新規フォルダの作成
    -   ファイル・フォルダの削除

### 3. メディアビューワー
-   NASやローカルに保存されている画像や動画を、アプリ内で直接閲覧・再生できます。
-   **動画プレーヤー**: 再生、一時停止、10秒スキップ/リワインドなどのカスタムコントロールを備えています。
-   **画像ビューワー**: 画像の表示に加え、トリミングなどの簡単な編集が可能です。

### 4. ファイルキャッシュ機能
-   NAS上のファイルをデバイスにダウンロード（キャッシュ）しておくことで、オフライン環境でもファイルにアクセスできます。
-   バックグラウンドでのダウンロードに対応しており、大きなファイルのダウンロードもスムーズです。

### 5. 家族間での情報共有
-   「父」「母」「共有」といった役割ごとの画面が用意されており、家族内での情報共有をサポートします。
-   **ToDoリスト**: Firestoreをデータベースとして利用したToDoリスト機能があり、家族へのタスク依頼や進捗管理が可能です。

### 6. お気に入り管理
-   よく利用するウェブサイトを「お気に入り」として登録し、一覧から素早くアクセスできます。

### 7. 開発者向け機能
-   アプリの動作状況を確認できるデバッグログ表示画面を搭載しています。

## 技術スタック（推測）

-   **フレームワーク**: Flutter
-   **バックエンド**: Firebase (Authentication, Firestore)
-   **NAS接続プロトコル**: SMB (Samba)
-   **ローカルデータベース**: SQLite (キャッシュ管理用)
-   **その他ライブラリ**:
    -   `firebase_auth`, `cloud_firestore`: Firebase連携
    -   `jcifs-ng`: (Androidネイティブ側で)SMBプロトコル通信
    -   `flutter_vlc_player` or `chewie`: 動画再生
    -   `image_cropper`, `image_picker`: 画像処理
    -   `sqflite`: ローカルデータ永続化
    -   `workmanager`: バックグラウンド処理

## 開発環境について

### OpenHandsとDockerを利用した開発
このプロジェクトは、Dockerコンテナ上でOpenHandsエージェントを用いて開発を行っています。コンテナの再起動によりSDKが削除される可能性があるため、開発を開始する際は以下の手順を確認してください。

1.  **環境チェック**:
    -   Flutter SDKおよびAndroid SDKがインストールされているかを確認します。
2.  **環境構築**:
    -   いずれかのSDKが存在しない場合、自動でインストールとセットアップを行います。
3.  **Setup Scriptsの利用徹底**:
    -   Docker再起動によるSDK消失の問題を防ぐため、Flutter SDKおよびAndroid SDKのインストール・設定、および`flutter pub get`などの初期環境構築手順は、Setup Scriptsとして定義し、作業開始時に自動実行されることを徹底してください。
4.  **Microagentsの適用検討**:
    -   複雑なSMBプロトコル通信やSQLiteによるキャッシュ管理、状態管理など、専門性の高い領域を実装する際は、Microagents（特化型プロンプト）の利用を検討し、その知識に基づいた正確な実装を行うこと。

OpenHandsのより詳細な仕様やリポジトリレベルでのカスタマイズについては、以下の公式ドキュメントを参照してください。
- [OpenHands Documentation: Repository Customization](https://docs.all-hands.dev/openhands/usage/customization/repository)

### OpenHandsへの指示事項 (改訂)

-   **応答言語**: OpenHandsからの応答は、すべて日本語で行うように設定してください。
-   **ビルド手順**: ビルドを指示された際は、APKファイルのサイズを最小化するため、64ビット版（arm64-v8a）のみをビルド対象とします。ビルド完了後、生成されたAPKファイルをGitHubリポジトリのリリースにアップロードします。最後に、アップロード先のURLを報告してください。
-   **デバッグログの実装**: コーディングを行う際は、後のデバッグを容易にするため、処理の開始・終了、主要な変数の値、およびエラー情報を、時系列に沿った詳細なデバッグログとして実装してください。ログはアプリ内の「お父さん機能」にある**「デバッグログ画面」**に出力し、アプリ上で直接確認できるようにしてください。
-   **タスクの細分化を徹底:** 複雑な機能改修や新機能追加は、必ず論理的に完結する小さな単位のタスクに分割し、一度に一つの明確なゴールのみに集中させて指示してください。
-   **Web検索の戦略的活用:** 未知のエラーや新しい技術に直面した際は、すぐに試行錯誤するのではなく、まずWeb検索機能を積極的に活用し、確度の高い情報を取得してから実装に入ること。
-   **コミット粒度の明確化:** 作業完了時は、一連の論理的な変更のみを含めた状態でコミットしてください。コミットメッセージには、「何を変更したか (What)」「なぜその変更が必要だったか (Why)」を簡潔に記述すること。
-   **エラー時の詳細な報告:** 動作中にエラーが発生した場合は、エラーメッセージの全文、直前に実行したコマンド、および試した対策を詳細に報告し、作業ログの透明性を確保すること。
-   **動作確認報告:** コーディング完了報告の際は、単に「修正完了」とするだけでなく、「どのように動作を確認したか（実行したテスト名、またはアプリ内での手動操作手順）」を具体的に明記すること。

### 開発ガイドライン (新規追加)

OpenHandsエージェントは、以下の品質基準と開発プラクティスを遵守して実装を行ってください。

1.  **コーディング規約の遵守**:
    -   Flutterの標準的な**Effective Dartガイドライン**を厳密に遵守してください。
    -   実装完了前に`flutter analyze`を実行し、**静的解析（Linter）の警告が残らないこと**を確認してください。

2.  **テストの実施**:
    -   主要なビジネスロジック（NAS連携、キャッシュ管理など）やUIに関わる機能を実装・改修する際は、**ユニットテスト**および**ウィジェットテスト**を同時に作成してください。これにより、回帰バグを防止し、コードの信頼性を向上させます。

3.  **堅牢なエラーハンドリング**:
    -   外部連携（Firebase, NAS, ネットワーク通信）やファイルI/Oが関わる処理では、必ず適切な`try-catch`ブロックを用いてください。
    -   エラー発生時は、単なる失敗メッセージではなく、**エラーの種類とエラーコード**を明確にログ出力してください。

4.  **外部依存の分離**:
    -   NAS、Firebase、ネットワーク通信など、外部サービスに依存するロジックをテストする際は、必ずモック（Mock）またはテストダブルを使用して依存関係を分離し、外部環境に影響されない安定したユニットテストを作成すること。

5.  **疑問点の確認**:
    -   指示内容に少しでも不明瞭な点や、既存のコードベースと矛盾する点がある場合は、自己判断せずに必ずユーザーに質問を投げかけ、誤った推測に基づく実装を避けてください。

## RARファイルのストリーミング閲覧機能

大容量のRARファイルでも即座に中身を閲覧できるよう、ネットワーク越しに直接ファイルをストリーミング処理する機能を実装しました。これにより、ユーザーはファイルを端末にダウンロードするのを待つ必要がなく、快適な操作性を体験できます。

### アーキテクチャと実装の詳細

この機能は、Flutter (UI)、Kotlin (Androidネイティブブリッジ)、C++ (コア処理) の3つのレイヤーが連携して動作します。

#### ファイル構成

-   **`lib/screens/rar_viewer_screen.dart`**:
    -   RARファイル内のエントリ（主に画像ファイル）を一覧表示するUI。
    -   `NasService` を通じてネイティブ機能を呼び出し、結果を `FutureBuilder` で非同期に表示します。

-   **`lib/screens/image_viewer_screen.dart`**:
    -   `rar_viewer_screen.dart` から渡された画像エントリを表示するUI。
    -   ページング機能を持ち、RARファイル内の画像をスワイプで切り替えられます。
    -   画像の読み込み時に `NasService` を通じてネイティブの画像展開処理を呼び出します。

-   **`lib/services/nas_service.dart`**:
    -   Flutterとネイティブコード間の通信を担う `MethodChannel` (`rar_channel`) を管理します。
    -   `listRarEntries` と `extractRarEntry` メソッドを提供し、UIコンポーネントからのネイティブ呼び出しを抽象化します。

-   **`android/app/src/main/kotlin/com/example/fujitake_app_new/MainActivity.kt`**:
    -   Flutterからの `MethodChannel` 呼び出しを受け取るブリッジ。
    -   SMBサーバーからファイルストリームを取得し、それをパイプ (`ParcelFileDescriptor.createPipe()`) に流し込みます。
    -   パイプの読み取り側のファイルディスクリプタ (`fd`) をC++のJNI関数に渡します。
    -   処理の各段階で `sendDebugLog` を呼び出し、Flutterのデバッグ画面にログを送信します。

-   **`android/app/src/main/cpp/native-lib.cpp`**:
    -   JNI関数 (`listRarEntries`, `extractRarEntry`) を実装しています。
    -   `libarchive` ライブラリを使用し、Kotlinから渡されたファイルディスクリプタ (`fd`) を `archive_read_open_fd()` で直接読み込みます。
    -   ファイルパスではなくファイルディスクリプタを扱うことで、ネットワーク越しのストリーミング処理を実現しています。

#### 処理フロー

1.  ユーザーが `nas_file_browser_screen.dart` でRARファイルをタップします。
2.  `RarViewerScreen` に遷移し、`NasService.listRarEntries` を呼び出します。
3.  **[Kotlin]** `MainActivity` が `listRarEntries` の呼び出しを受け取ります。
4.  **[Kotlin]** SMBストリームを開始し、そのデータをパイプの書き込み側にコピーします。
5.  **[Kotlin]** パイプの読み取り側ディスクリプタを、C++の `listRarEntries` JNI関数に渡します。
6.  **[C++]** `libarchive` がディスクリプタを通じてストリームを読み込み、RARファイルヘッダを解析してファイル名の一覧を返します。
7.  **[Flutter]** `RarViewerScreen` がファイル一覧を受け取り、画像ファイルのみをリスト表示します。
8.  ユーザーがリスト内の画像をタップします。
9.  `ImageViewerScreen` に遷移し、`NasService.extractRarEntry` を呼び出します。
10. **[Kotlin -> C++]** 上記と同様の流れで、今度は `extractRarEntry` JNI関数が呼び出されます。
11. **[C++]** `libarchive` が指定されたエントリを探し、そのデータ（バイト配列）を展開して返します。
12. **[Flutter]** `ImageViewerScreen` が画像のバイトデータを受け取り、`Image.memory()` ウィジェットで表示します。

### デバッグと検証の方法

本機能のデバッグは、アプリ内のデバッグログ画面を利用して行います。

1.  アプリを起動し、「お父さん機能」メニューから「デバッグログ画面」に遷移します。
2.  NASファイルブラウザでRARファイルを操作します。
3.  KotlinおよびDartで実装されたログがリアルタイムで画面に出力されます。ログには `[RarViewerScreen]`, `[Native]`, `[NasService]` などのプレフィックスが付与されており、どのレイヤーで何が起きているかを時系列で追跡できます。

特に以下のログに注目することで、問題の切り分けが容易になります。
-   `[Native] RAR_CHANNEL: Received call ...`: Flutterからネイティブへの呼び出しが成功しているか。
-   `[Native] RAR_CHANNEL: Starting SMB stream copy...`: SMBサーバーへの接続とストリーミングが開始されたか。
-   `[Native] RAR_CHANNEL: Calling native ...`: C++のJNI関数が呼び出されているか。
-   `[NasService] Found ... entries.`: ネイティブ処理が成功し、データがFlutterに返されているか。

### 今後の課題 (TODO)

-   **パフォーマンス改善**:
    -   `ImageViewerScreen` の見開き表示機能は、画像の寸法を取得するために全画像データを読み込む可能性があります。巨大なRARファイルの場合、これがパフォーマンスのボトルネックになる可能性があります。`libarchive` を使って画像のヘッダだけを読み、寸法情報のみを高速に取得するネイティブ関数の追加を検討してください。

-   **エラーハンドリングの強化**:
    -   現状では、ネイティブ処理でエラーが発生した場合、Flutter側では「0件のエントリ」または `null` として扱われます。`archive_error_string()` で得られる詳細なエラーメッセージをKotlin経由でFlutterに渡し、ユーザーに具体的な原因（例：「パスワードで保護されたRARです」「ファイルが破損しています」）を提示できるように改善してください。

-   **C++からの直接ログ出力**:
    -   現在、C++からのログは出力していません。デバッグをさらに容易にするため、JNIを通じてKotlinの `sendDebugLog` を呼び出す仕組みを構築し、`libarchive` の処理中やエラー発生時に詳細なログを出力することを検討してください。

